# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ —Ç–æ–º, –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ" –º–æ–∂–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏: —Ä–∞—Å—Å—ã–ª–∫–∏, —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥—Ä—É–≥–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#–æ–±–∑–æ—Ä-–º–µ—Ö–∞–Ω–∏–∑–º–æ–≤-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
2. [VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ Mini App](#vk-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è-–≤–Ω—É—Ç—Ä–∏-mini-app)
3. [VK API –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ](#vk-api-–¥–ª—è-—Ä–∞—Å—Å—ã–ª–æ–∫-—á–µ—Ä–µ–∑-—Å–æ–æ–±—â–µ—Å—Ç–≤–æ)
4. [–í–Ω—É—Ç—Ä–∏–ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#–≤–Ω—É—Ç—Ä–∏–ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
5. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø–æ–¥–ø–∏—Å–∫–∞–º–∏-–Ω–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
6. [–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#—Ç–∏–ø—ã-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
7. [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫](#—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-—Ä–∞—Å—Å—ã–ª–æ–∫)
8. [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è](#—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è-–æ-—Å—Ç–∞—Ç—É—Å–µ-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:

### 1. **VK Bridge API** (–≤–Ω—É—Ç—Ä–∏ Mini App)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: VK Bridge –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (`frontend/src/lib/vkCore.ts`)
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ Mini App
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ß–µ—Ä–µ–∑ `bridge.send("VKWebAppShowNotification", {...})`
- ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### 2. **VK API –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤** (—Ä–∞—Å—Å—ã–ª–∫–∏)
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: VK API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º VK —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
- üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [VK API messages.send](https://dev.vk.com/ru/api/community/messages)

### 3. **–í–Ω—É—Ç—Ä–∏–ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: Toast –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`frontend/src/shared/ui/ui/toast.tsx`)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: Sonner –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (`frontend/src/shared/ui/ui/sonner.tsx`)
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∞–ª–µ—Ä—Ç—ã, –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ß–µ—Ä–µ–∑ `toast()` –∏ `useToast()` —Ö—É–∫–∏

---

## VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ Mini App

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

VK Bridge API –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

**–§–∞–π–ª:** `frontend/src/lib/vkCore.ts`

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ `vkCore.ts`:

```typescript
// frontend/src/lib/vkCore.ts

import bridge from "@vkontakte/vk-bridge";

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ VK Mini App
 * 
 * @param text - –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
 * @param options - –û–ø—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
 * @returns Promise<boolean> - –£—Å–ø–µ—à–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
 */
export const showNotification = async (
  text: string,
  options?: {
    type?: 'info' | 'success' | 'error';
  }
): Promise<boolean> => {
  if (!isBridgeAvailable()) {
    // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π alert
    console.warn("[vk] Bridge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º alert");
    alert(text);
    return false;
  }

  try {
    await bridge.send("VKWebAppShowNotification", {
      text,
      type: options?.type || 'info',
    });
    return true;
  } catch (error) {
    console.warn("[vk] showNotification failed", error);
    // Fallback –Ω–∞ alert
    alert(text);
    return false;
  }
};
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```typescript
import { showNotification } from "@/lib/vk";

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
await showNotification("‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", {
  type: 'success',
});

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
await showNotification("üìã –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è", {
  type: 'info',
});

// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
await showNotification("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", {
  type: 'error',
});
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è VK Bridge —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

- **–¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Mini App:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- **–ù–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** VK Bridge –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–î–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫:** –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VK API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ

---

## VK API –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VK API

–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ VK –Ω—É–∂–Ω–æ:

1. **–°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ VK** (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
2. **–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞** —Å –ø—Ä–∞–≤–∞–º–∏ `messages`
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π API** –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è VK API

- [VK API messages.send](https://dev.vk.com/ru/api/community/messages)
- [VK API –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞](https://dev.vk.com/ru/api/access-token/getting-started)

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

```javascript
// backend/server/services/vkMessagingService.mjs

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ VK API
 */
export class VKMessagingService {
  constructor() {
    this.accessToken = process.env.VK_ACCESS_TOKEN;
    this.apiVersion = '5.131';
    this.apiUrl = 'https://api.vk.com/method';
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é VK
   * 
   * @param {number} userId - VK ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
   * @param {object} options - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
   * @returns {Promise<object>}
   */
  async sendMessage(userId, message, options = {}) {
    if (!this.accessToken) {
      throw new Error('VK_ACCESS_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    }

    const params = new URLSearchParams({
      user_id: userId,
      message: message,
      access_token: this.accessToken,
      v: this.apiVersion,
      random_id: Math.floor(Math.random() * 2147483647),
      ...options,
    });

    try {
      const response = await fetch(`${this.apiUrl}/messages.send?${params}`);
      const data = await response.json();

      if (data.error) {
        throw new Error(`VK API Error: ${data.error.error_msg} (${data.error.error_code})`);
      }

      return { success: true, messageId: data.response };
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ VK API:', error);
      throw error;
    }
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
   * 
   * @param {number[]} userIds - –ú–∞—Å—Å–∏–≤ VK ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
   * @param {object} options - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
   * @returns {Promise<object>}
   */
  async sendBroadcast(userIds, message, options = {}) {
    const results = {
      sent: 0,
      failed: 0,
      errors: [],
    };

    // VK API –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
    for (const userId of userIds) {
      try {
        await this.sendMessage(userId, message, options);
        results.sent++;
        // –ó–∞–¥–µ—Ä–∂–∫–∞ 10ms –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (100 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)
        await new Promise(resolve => setTimeout(resolve, 10));
      } catch (error) {
        results.failed++;
        results.errors.push({
          userId,
          error: error.message,
        });
      }
    }

    return results;
  }
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ API endpoint –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫

```javascript
// backend/server/routes/notificationsRoutes.mjs

import express from "express";
import { queryMany } from "../postgresClient.mjs";
import { VKMessagingService } from "../services/vkMessagingService.mjs";

export function createNotificationsRouter() {
  const router = express.Router();
  const vkMessaging = new VKMessagingService();

  /**
   * POST /api/notifications/broadcast
   * –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º VK
   */
  router.post("/broadcast", async (req, res) => {
    const { message, filters = {} } = req.body;

    if (!message) {
      return res.status(400).json({
        success: false,
        error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'
      });
    }

    try {
      // –§–æ—Ä–º–∏—Ä—É–µ–º SQL –∑–∞–ø—Ä–æ—Å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
      let sql = `
        SELECT vk_id
        FROM user_profiles
        WHERE notifications_enabled = true
        AND vk_id IS NOT NULL
      `;

      const params = [];
      let paramIndex = 1;

      if (filters.cityId) {
        sql += ` AND favorite_city_id = $${paramIndex++}`;
        params.push(filters.cityId);
      }

      if (filters.restaurantId) {
        sql += ` AND favorite_restaurant_id = $${paramIndex++}`;
        params.push(filters.restaurantId);
      }

      const users = await queryMany(sql, params);
      const vkIds = users.map(u => Number(u.vk_id)).filter(Boolean);

      if (vkIds.length === 0) {
        return res.json({
          success: true,
          sent: 0,
          failed: 0,
          total: 0,
          message: '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏'
        });
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å—Å—ã–ª–∫—É
      const results = await vkMessaging.sendBroadcast(vkIds, message);

      return res.json({
        success: true,
        ...results,
        total: vkIds.length,
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏:', error);
      return res.status(500).json({
        success: false,
        error: error.message
      });
    }
  });

  return router;
}
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```bash
VK_ACCESS_TOKEN=your_vk_access_token_here
```

---

## –í–Ω—É—Ç—Ä–∏–ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–∞ —Ç–∏–ø–∞ toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

1. **Radix UI Toast** (`frontend/src/shared/ui/ui/toast.tsx`)
2. **Sonner** (`frontend/src/shared/ui/ui/sonner.tsx`)

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Toast (Radix UI)

```typescript
import { useToast } from "@/hooks";

function MyComponent() {
  const { toast } = useToast();

  const handleSuccess = () => {
    toast({
      title: "–£—Å–ø–µ—à–Ω–æ!",
      description: "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ",
    });
  };

  const handleError = () => {
    toast({
      title: "–û—à–∏–±–∫–∞",
      description: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
      variant: "destructive",
    });
  };

  return (
    // ...
  );
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Sonner

```typescript
import { toast } from "sonner";

// –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
toast.success("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!");
toast.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è");
toast.info("–í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è");

// –° –æ–ø–∏—Å–∞–Ω–∏–µ–º
toast.success("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", {
  description: "–î–∞—Ç–∞: 15 –¥–µ–∫–∞–±—Ä—è, 19:00",
});

// –° –¥–µ–π—Å—Ç–≤–∏–µ–º
toast.success("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", {
  action: {
    label: "–û—Ç–∫—Ä—ã—Ç—å",
    onClick: () => navigate("/bookings"),
  },
});
```

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–µ

**–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:**
```typescript
// frontend/src/features/booking/BookingForm.tsx

import { toast } from "sonner";
import { showNotification } from "@/lib/vk";

const handleBookingSuccess = async (booking) => {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
  toast.success("‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", {
    description: `–î–∞—Ç–∞: ${booking.date}, –í—Ä–µ–º—è: ${booking.time}`,
  });

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ VK Bridge (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
  if (isInVk()) {
    await showNotification("‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", {
      type: 'success',
    });
  }
};
```

**–ü—Ä–∏ –æ—à–∏–±–∫–µ:**
```typescript
const handleError = (error: Error) => {
  toast.error("–û—à–∏–±–∫–∞", {
    description: error.message,
  });

  if (isInVk()) {
    showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, {
      type: 'error',
    });
  }
};
```

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–í –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø–æ–ª–µ `notificationsEnabled`:

**–¢–∞–±–ª–∏—Ü–∞ –ë–î:** `user_profiles.notifications_enabled` (BOOLEAN DEFAULT true)

**–¢–∏–ø:** `frontend/src/shared/types/profile.ts`

```typescript
type UserProfile = {
  // ...
  notificationsEnabled: boolean;
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è VK

```typescript
// frontend/src/lib/vkCore.ts

/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 */
export const areNotificationsEnabled = (): boolean => {
  const initData = getInitData();
  return initData?.vk_are_notifications_enabled === '1';
};
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```typescript
// frontend/src/features/profile/edit/EditProfile.tsx

import { updateProfile } from "@/shared/api/profile";
import { toast } from "sonner";

const handleNotificationsToggle = async (enabled: boolean) => {
  try {
    await updateProfile({
      notificationsEnabled: enabled,
    });
    
    toast.success(
      enabled 
        ? "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã" 
        : "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã"
    );
  } catch (error) {
    toast.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏");
  }
};
```

---

## –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏

#### –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
import { toast } from "sonner";
import { showNotification } from "@/lib/vk";
import { isInVk } from "@/lib/vk";

async function notifyBookingCreated(booking: BookingData) {
  const message = `‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!\n–î–∞—Ç–∞: ${booking.date}, –í—Ä–µ–º—è: ${booking.time}`;
  
  // Toast –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
  toast.success("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", {
    description: `–î–∞—Ç–∞: ${booking.date}, –í—Ä–µ–º—è: ${booking.time}`,
  });

  // VK Bridge —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –≤ VK)
  if (isInVk()) {
    await showNotification(message, { type: 'success' });
  }
}
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// –ö–æ–≥–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
import { VKMessagingService } from "@/services/vkMessagingService";

async function notifyBookingStatusChange(
  bookingId: string, 
  newStatus: string
) {
  const booking = await getBooking(bookingId);
  const user = await getUserProfile(booking.userId);

  if (!user.notificationsEnabled) {
    return;
  }

  const statusMessages = {
    created: "‚úÖ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!",
    confirmed: "üéâ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!",
    cancelled: "‚ùå –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
  };

  const message = [
    statusMessages[newStatus] || "üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –≤–∞—à–µ–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é",
    "",
    `üìÖ –î–∞—Ç–∞: ${booking.date}`,
    `üïê –í—Ä–µ–º—è: ${booking.time}`,
    `üë• –ì–æ—Å—Ç–µ–π: ${booking.guestsCount}`,
    `üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω: ${booking.restaurantName}`,
  ].join("\n");

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ VK API (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ VK)
  if (user.vkId) {
    const vkMessaging = new VKMessagingService();
    try {
      await vkMessaging.sendMessage(user.vkId, message);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
    }
  }
}
```

### 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö

```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
async function notifyOrderCreated(orderId: string) {
  const order = await getOrder(orderId);
  const user = await getUserProfile(order.userId);

  const message = [
    "üõí –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!",
    "",
    `–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: #${order.id}`,
    `–°—É–º–º–∞: ${order.total} ‚ÇΩ`,
    "",
    "–û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
  ].join("\n");

  // Toast –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
  toast.success("–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!", {
    description: `–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: #${order.id}`,
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ VK API
  if (user.vkId && user.notificationsEnabled) {
    const vkMessaging = new VKMessagingService();
    await vkMessaging.sendMessage(user.vkId, message);
  }
}
```

### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–∫—Ü–∏—è—Ö

```typescript
// –†–∞—Å—Å—ã–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫—Ü–∏–∏
async function notifyPromotion(promotionId: string) {
  const promotion = await getPromotion(promotionId);
  
  const message = [
    "üéÅ –ù–æ–≤–∞—è –∞–∫—Ü–∏—è!",
    "",
    promotion.title,
    promotion.description,
    "",
    `–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${promotion.endDate}`,
  ].join("\n");

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ VK API
  const vkMessaging = new VKMessagingService();
  await vkMessaging.sendBroadcastToFilteredUsers(message, {
    notificationsEnabled: true,
    cityId: promotion.cityId, // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥—É
  });
}
```

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞—Å—Å—ã–ª–æ–∫

–î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á:

```javascript
// backend/server/services/broadcastService.mjs

import { queryMany } from "../postgresClient.mjs";
import { VKMessagingService } from "./vkMessagingService.mjs";

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
 */
export class BroadcastService {
  constructor() {
    this.vkMessaging = new VKMessagingService();
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º VK
   */
  async sendBroadcast(message, options = {}) {
    const {
      notificationsEnabled = true,
      cityId = null,
      restaurantId = null,
    } = options;

    // –§–æ—Ä–º–∏—Ä—É–µ–º SQL –∑–∞–ø—Ä–æ—Å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    let sql = `
      SELECT 
        id,
        vk_id,
        name,
        phone
      FROM user_profiles
      WHERE notifications_enabled = $1
      AND vk_id IS NOT NULL
    `;

    const params = [notificationsEnabled];
    let paramIndex = 2;

    if (cityId) {
      sql += ` AND favorite_city_id = $${paramIndex++}`;
      params.push(cityId);
    }

    if (restaurantId) {
      sql += ` AND favorite_restaurant_id = $${paramIndex++}`;
      params.push(restaurantId);
    }

    const users = await queryMany(sql, params);
    const vkIds = users.map(u => Number(u.vk_id)).filter(Boolean);

    if (vkIds.length === 0) {
      return {
        total: 0,
        sent: 0,
        failed: 0,
        errors: [],
      };
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ VK API
    const results = await this.vkMessaging.sendBroadcast(vkIds, message);

    return {
      total: vkIds.length,
      ...results,
    };
  }

  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ API endpoint –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫

```javascript
// backend/server/routes/adminRoutes.mjs

import { BroadcastService } from "../services/broadcastService.mjs";

// –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–æ—É—Ç–µ—Ä
router.post("/broadcast", async (req, res) => {
  const admin = await authoriseSuperAdmin(req, res);
  if (!admin) {
    return;
  }

  const { message, filters = {} } = req.body;

  if (!message) {
    return res.status(400).json({
      success: false,
      error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'
    });
  }

  try {
    const broadcastService = new BroadcastService();
    const results = await broadcastService.sendBroadcast(message, filters);

    return res.json({
      success: true,
      ...results,
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏:', error);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–æ–∫ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

```typescript
// frontend/src/shared/api/broadcastApi.ts

export async function sendBroadcast(
  message: string,
  filters: {
    cityId?: string;
    restaurantId?: string;
  }
) {
  const response = await fetch(`${API_URL}/api/admin/broadcast`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∞–¥–º–∏–Ω–∞
    },
    body: JSON.stringify({
      message,
      filters,
    }),
  });

  return response.json();
}
```

---

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Remarked API –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î:

**–§–∞–π–ª:** `backend/server/routes/bookingRoutes.mjs`

**–¢–∞–±–ª–∏—Ü–∞:** `bookings` —Å –ø–æ–ª–µ–º `status` ('created' | 'confirmed' | 'cancelled')

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ

#### 1. Webhook –æ—Ç Remarked (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

```javascript
// backend/server/routes/bookingRoutes.mjs

/**
 * POST /api/booking/webhook
 * Webhook –æ—Ç Remarked –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
 */
router.post("/webhook", async (req, res) => {
  const { reserve_id, status, ...otherData } = req.body;

  // –ù–∞—Ö–æ–¥–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î
  const booking = await queryOne(
    `SELECT * FROM bookings WHERE remarked_reserve_id = $1`,
    [reserve_id]
  );

  if (!booking) {
    return res.status(404).json({ success: false });
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
  await query(
    `UPDATE bookings SET status = $1, updated_at = NOW() WHERE id = $2`,
    [status, booking.id]
  );

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  await notifyBookingStatusChange(booking, status);

  return res.json({ success: true });
});
```

#### 2. –§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```javascript
// backend/server/services/notificationService.mjs

import { queryOne } from "../postgresClient.mjs";
import { VKMessagingService } from "./vkMessagingService.mjs";

/**
 * –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
 */
export async function notifyBookingStatusChange(booking, newStatus) {
  // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const user = await queryOne(
    `SELECT vk_id, notifications_enabled, name 
     FROM user_profiles 
     WHERE id = $1 OR phone = $2`,
    [booking.userId, booking.customer_phone]
  );

  if (!user || !user.notifications_enabled) {
    return;
  }

  const statusMessages = {
    created: "‚úÖ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!",
    confirmed: "üéâ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!",
    cancelled: "‚ùå –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
  };

  const message = [
    statusMessages[newStatus] || "üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –≤–∞—à–µ–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é",
    "",
    `üìÖ –î–∞—Ç–∞: ${booking.booking_date}`,
    `üïê –í—Ä–µ–º—è: ${booking.booking_time}`,
    `üë• –ì–æ—Å—Ç–µ–π: ${booking.guests_count}`,
    `üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω: ${booking.restaurant_name || '–†–µ—Å—Ç–æ—Ä–∞–Ω'}`,
  ].join("\n");

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ VK API
  if (user.vk_id) {
    const vkMessaging = new VKMessagingService();
    try {
      await vkMessaging.sendMessage(Number(user.vk_id), message);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
    }
  }
}
```

#### 3. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```javascript
// backend/server/services/bookingStatusChecker.mjs

/**
 * –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ Remarked
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
 */
export async function checkBookingStatuses() {
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  const bookings = await queryMany(`
    SELECT * FROM bookings 
    WHERE status IN ('created', 'confirmed')
    AND booking_date >= CURRENT_DATE
  `);

  for (const booking of bookings) {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Remarked
      const status = await checkRemarkedStatus(booking.remarked_reserve_id);
      
      if (status !== booking.status) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await query(
          `UPDATE bookings SET status = $1 WHERE id = $2`,
          [status, booking.id]
        );
        await notifyBookingStatusChange(booking, status);
      }
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ${booking.id}:`, error);
    }
  }
}
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```typescript
// backend/server/services/notificationService.mjs

import { VKMessagingService } from "./vkMessagingService.mjs";
import { queryOne } from "../postgresClient.mjs";

export class NotificationService {
  constructor() {
    this.vkMessaging = new VKMessagingService();
  }

  async send(recipient: {
    userId: string;
    vkId?: number;
  }, notification: {
    type: string;
    title: string;
    message: string;
    data?: unknown;
  }) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await queryOne(
      `SELECT notifications_enabled FROM user_profiles WHERE id = $1`,
      [recipient.userId]
    );

    if (!user || !user.notifications_enabled) {
      return { sent: false, reason: 'notifications_disabled' };
    }

    const results = {
      vk: false,
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ VK API
    if (recipient.vkId) {
      try {
        await this.vkMessaging.sendMessage(
          recipient.vkId,
          `${notification.title}\n\n${notification.message}`
        );
        results.vk = true;
      } catch (error) {
        console.error('VK notification failed:', error);
      }
    }

    return results;
  }
}
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫

–î–ª—è –±–æ–ª—å—à–∏—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Bull –∏–ª–∏ BullMQ):

```javascript
// backend/server/queues/broadcastQueue.mjs

import Queue from 'bull';

const broadcastQueue = new Queue('broadcast', {
  redis: { host: 'localhost', port: 6379 }
});

broadcastQueue.process(async (job) => {
  const { message, userIds } = job.data;
  
  const vkMessaging = new VKMessagingService();
  await vkMessaging.sendBroadcast(userIds, message);
});

export { broadcastQueue };
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```javascript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î
await query(`
  INSERT INTO notification_logs (
    user_id,
    type,
    platform,
    message,
    status,
    sent_at
  ) VALUES ($1, $2, $3, $4, $5, NOW())
`, [userId, type, 'vk', message, status]);
```

---

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### VK Bridge —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

- ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π VK, –Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∏–¥
- ‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Mini App, –Ω–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### VK API –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤

- ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –≤—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç—å
- ‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –¢—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞, –ª–∏–º–∏—Ç—ã API (100 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)
- üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≤–∞–∂–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∑–∞–∫–∞–∑—ã)

### –í–Ω—É—Ç—Ä–∏–ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

- ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö API
- ‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –†–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –¥–µ–π—Å—Ç–≤–∏–π, –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ** `notificationsEnabled` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
2. **–õ–æ–≥–∏—Ä—É–π—Ç–µ** –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
3. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏** gracefully
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—á–µ—Ä–µ–¥–∏** –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
5. **–£–≤–∞–∂–∞–π—Ç–µ –ª–∏–º–∏—Ç—ã** VK API (100 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)
6. **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
7. **–ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ** —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ª—É—á—à–µ–≥–æ UX

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [VK Bridge API Documentation](https://dev.vk.com/ru/bridge/overview)
- [VK Mini Apps Guide](https://dev.vk.com/ru/mini-apps/overview)
- [VK API –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤](https://dev.vk.com/ru/api/community)
- [VK API messages.send](https://dev.vk.com/ru/api/community/messages)
- [Sonner Documentation](https://sonner.emilkowal.ski/)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024
