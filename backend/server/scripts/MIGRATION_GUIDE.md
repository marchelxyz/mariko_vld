# Руководство по миграции базы данных с VK Cloud на Railway

Это руководство описывает процесс миграции всех данных из PostgreSQL базы данных VK Cloud на PostgreSQL базу данных Railway.

## Подготовка

### 1. Установка переменных окружения

Создайте файл `.env.local` в директории `backend/server/` или установите переменные окружения в системе:

```bash
# Подключение к исходной БД (VK Cloud)
SOURCE_DATABASE_URL=postgresql://user:password@vk-cloud-host:port/database

# Подключение к целевой БД (Railway)
DATABASE_URL=postgresql://user:password@railway-host:port/database

# Опционально: настройки SSL
SOURCE_DATABASE_SSL=true  # если VK Cloud требует SSL
DATABASE_SSL=true         # если Railway требует SSL
```

### 2. Проверка подключений

Убедитесь, что обе базы данных доступны и вы можете подключиться к ним:

```bash
# Проверка подключения к VK Cloud
psql "$SOURCE_DATABASE_URL" -c "SELECT 1"

# Проверка подключения к Railway
psql "$DATABASE_URL" -c "SELECT 1"
```

## Запуск миграции

### Локальный запуск

```bash
cd backend/server
node scripts/migrateDatabaseToRailway.mjs
```

### Запуск из корня проекта

```bash
node backend/server/scripts/migrateDatabaseToRailway.mjs
```

## Что мигрирует скрипт

Скрипт автоматически мигрирует:

1. **Все таблицы** - создает структуру всех таблиц из исходной БД
2. **Все данные** - копирует все записи из всех таблиц
3. **Все индексы** - создает все индексы для оптимизации запросов
4. **Все последовательности (sequences)** - мигрирует sequences с сохранением текущих значений
5. **Все ограничения**:
   - Primary keys
   - Foreign keys
   - CHECK constraints
   - UNIQUE constraints

## Процесс миграции

1. **Проверка подключений** - скрипт проверяет доступность обеих баз данных
2. **Получение списка таблиц** - определяет все таблицы для миграции
3. **Миграция sequences** - создает и настраивает sequences
4. **Миграция таблиц** - для каждой таблицы:
   - Создает структуру таблицы
   - Копирует данные (батчами по 500 записей)
   - Создает индексы
   - Создает foreign keys
   - Создает CHECK и UNIQUE constraints
5. **Вывод статистики** - показывает результаты миграции

## Особенности

### Обработка конфликтов

- При копировании данных используется `ON CONFLICT DO NOTHING`, что означает, что существующие записи не будут перезаписаны
- Если таблица уже существует в целевой БД, она будет удалена и пересоздана (CASCADE)

### Производительность

- Данные копируются батчами по 500 записей для оптимизации памяти и скорости
- Для больших таблиц используется прогресс-бар для отслеживания процесса

### Обработка ошибок

- Скрипт продолжает работу даже при ошибках в отдельных таблицах
- Все ошибки логируются с подробной информацией
- В конце выводится статистика успешно мигрированных таблиц

## После миграции

### Проверка данных

Проверьте, что все данные успешно мигрированы:

```bash
# Подключитесь к Railway БД
psql "$DATABASE_URL"

# Проверьте количество записей в таблицах
SELECT 'user_profiles' as table_name, COUNT(*) FROM user_profiles
UNION ALL
SELECT 'cart_orders', COUNT(*) FROM cart_orders
UNION ALL
SELECT 'restaurants', COUNT(*) FROM restaurants;
-- и т.д. для всех таблиц
```

### Обновление переменных окружения

После успешной миграции обновите переменную `DATABASE_URL` в Railway на новое значение:

```bash
# В Railway CLI
railway variables set DATABASE_URL="postgresql://..." --service backend
```

Или через веб-интерфейс Railway:
1. Откройте ваш проект в Railway
2. Перейдите в раздел Variables
3. Обновите значение `DATABASE_URL`

## Устранение проблем

### Ошибка подключения

Если возникают ошибки подключения:

1. Проверьте правильность `SOURCE_DATABASE_URL` и `DATABASE_URL`
2. Убедитесь, что обе БД доступны из вашей сети
3. Проверьте настройки файрвола и SSL

### Ошибки при создании таблиц

Если возникают ошибки при создании таблиц:

1. Проверьте логи скрипта для деталей ошибки
2. Убедитесь, что в целевой БД достаточно прав для создания таблиц
3. Проверьте, что все зависимости (например, расширения PostgreSQL) установлены

### Неполная миграция данных

Если не все данные мигрированы:

1. Проверьте логи скрипта на наличие ошибок
2. Убедитесь, что в целевой БД достаточно места
3. Проверьте ограничения по времени выполнения (timeout)

## Безопасность

⚠️ **Важно:**

- Не храните пароли БД в открытом виде в файлах
- Используйте `.env.local` и добавьте его в `.gitignore`
- После миграции удалите файл `.env.local` или зашифруйте его
- Не коммитьте файлы с паролями в git

## Поддержка

При возникновении проблем:

1. Проверьте логи скрипта
2. Убедитесь, что обе БД доступны
3. Проверьте версии PostgreSQL (рекомендуется одинаковые версии)
