# Подключение домена к Railway и настройка failover

Это руководство поможет вам подключить домен к приложению на Railway и настроить переадресацию запросов на запасной сервер (failover) при проблемах с основным сервером.

## Содержание

1. [Получение IP адреса Railway](#получение-ip-адреса-railway)
2. [Подключение домена к Railway](#подключение-домена-к-railway)
3. [Настройка failover через Timeweb](#настройка-failover-через-timeweb)
4. [Проверка работы](#проверка-работы)

---

## Получение домена Railway (не IP адреса!)

⚠️ **Важно:** Railway использует динамические IP адреса, которые меняются при перезапуске. Для подключения домена **используйте доменное имя Railway**, а не IP адрес. Подробное объяснение см. в [`RAILWAY_DOMAIN_EXPLAINED.md`](./RAILWAY_DOMAIN_EXPLAINED.md).

### Как получить домен Railway:

1. Откройте [Railway Dashboard](https://railway.app)
2. Выберите ваш проект
3. Выберите сервис (например, backend)
4. Перейдите в **Settings** → **Networking**
5. Скопируйте домен (например: `backend.up.railway.app`)

Этот домен вам понадобится для настройки Nginx на Timeweb.

### Когда может понадобиться IP адрес?

IP адрес Railway может понадобиться только для:
- Настройки firewall правил
- Ограничения доступа к базе данных (Yandex Managed PostgreSQL)
- Отладки сетевых подключений

Но для подключения домена IP адрес **не нужен** — используйте доменное имя Railway через проксирование на Timeweb.

---

## Подключение домена к Railway

### Вариант 1: Прямое подключение домена к Railway (без failover)

⚠️ **Не рекомендуется** для production, так как нет автоматического переключения на запасной сервер при проблемах.

1. **В Railway Dashboard:**
   - Откройте ваш проект → выберите сервис
   - Перейдите в **Settings** → **Networking**
   - Нажмите **Custom Domain**
   - Введите ваш домен (например: `api.example.com`)

2. **В панели управления DNS вашего регистратора:**
   - Создайте **CNAME** запись:
     - Имя: `api` (или `@` для корневого домена)
     - Значение: `backend.up.railway.app` (ваш домен Railway)
     - TTL: `3600` (или по умолчанию)

3. **Ожидайте распространения DNS** (обычно 5-60 минут)

4. **Railway автоматически выпустит SSL сертификат** через Let's Encrypt

### Вариант 2: Через проксирование на Timeweb (с failover)

Этот вариант позволяет настроить автоматическое переключение на запасной сервер при проблемах с Railway. Подробная инструкция в [`TIMEWEB_FAILOVER.md`](./TIMEWEB_FAILOVER.md).

**Кратко:**
1. Домен указывает на IP адрес Timeweb (статический IP)
2. На Timeweb настроен Nginx, который проксирует запросы:
   - `/api/` → Railway (основной сервер)
   - `/api/` → локальный backend на Timeweb (запасной сервер при проблемах)
3. При недоступности Railway автоматически переключается на Timeweb

---

## Настройка failover через Timeweb

Для настройки failover вам понадобится:

1. **VPS на Timeweb** с настроенным Nginx
2. **Домен**, который будет указывать на Timeweb
3. **Локальная копия приложения** на Timeweb (запасной сервер)

### Пошаговая инструкция

#### Шаг 1: Получите IP адрес Timeweb

В панели Timeweb:
- Перейдите в раздел вашего VPS
- Найдите **IP адрес** сервера (например: `85.198.83.72`)

#### Шаг 2: Получите домен Railway

1. Откройте [Railway Dashboard](https://railway.app)
2. Выберите ваш проект → сервис backend
3. Перейдите в **Settings** → **Networking**
4. Скопируйте домен Railway (например: `backend.up.railway.app`)

Этот домен понадобится для настройки Nginx на Timeweb.

#### Шаг 3: Настройте DNS записи

В панели управления DNS вашего регистратора домена:

- **A запись:**
  - Имя: `@` (или оставьте пустым для корневого домена)
  - Значение: IP адрес Timeweb (например: `85.198.83.72`)
  - TTL: `3600` (или по умолчанию)

- **A запись для www:**
  - Имя: `www`
  - Значение: IP адрес Timeweb
  - TTL: `3600`

#### Шаг 4: Настройте Nginx на Timeweb

⚠️ **Важно:** Для настройки Nginx на Timeweb вам понадобится доступ к серверу через SSH или веб-панель управления сервером.

1. **Выпустите SSL сертификат** (Let's Encrypt):

   Если у вас есть доступ к веб-панели Timeweb с управлением SSL:
   - Найдите раздел "SSL сертификаты" или "Let's Encrypt"
   - Добавьте сертификат для вашего домена
   - Сертификат будет автоматически установлен

   Если доступен только SSH, используйте веб-панель управления сервером или обратитесь в поддержку Timeweb.

2. **Создайте конфигурацию Nginx:**

   Откройте файл `scripts/timeweb/nginx-failover.conf.template` в репозитории и скопируйте его содержимое.

   Замените в тексте следующие значения:
   - `__DOMAIN__` → ваш домен (например: `example.com`)
   - `__VERCEL_ORIGIN__` → домен Vercel (например: `mariko-vld.vercel.app`)
   - `__RAILWAY_ORIGIN__` → домен Railway (например: `backend.up.railway.app`) — **используйте доменное имя, а не IP!**
   - `__FALLBACK_WEB_ROOT__` → `/var/www/html`
   - `__LOCAL_API_PORT__` → `4010`

3. **Загрузите конфигурацию на сервер:**

   Через веб-панель управления сервером Timeweb:
   - Найдите раздел "Файловый менеджер" или "Nginx конфигурация"
   - Создайте файл конфигурации в `/etc/nginx/sites-available/` (например: `example.com`)
   - Вставьте отредактированный текст конфигурации
   - Создайте симлинк в `/etc/nginx/sites-enabled/` (или включите сайт через панель управления)
   - Перезагрузите Nginx через панель управления

   Если у вас есть доступ к SSH, обратитесь к разделу "Проверка работы" в [`TIMEWEB_FAILOVER.md`](./TIMEWEB_FAILOVER.md).

#### Шаг 5: Разверните запасной сервер на Timeweb

Следуйте инструкциям в [`TIMEWEB_FAILOVER.md`](./TIMEWEB_FAILOVER.md), раздел "2) Сделать прямо сейчас".

#### Шаг 6: Обновите переменные окружения

**В Vercel:**
- `VITE_SERVER_API_URL=/api` (относительный путь, Nginx сам решит куда проксировать)

**В Railway (bot service):**
- `WEBAPP_URL=https://<ваш-домен>`

---

## Проверка работы

### Проверка DNS записей

Используйте онлайн-сервисы для проверки DNS:
- [whatsmydns.net](https://www.whatsmydns.net) — проверка DNS записей по всему миру
- [dnschecker.org](https://dnschecker.org) — проверка DNS записей

Введите ваш домен и проверьте, что A запись указывает на IP адрес Timeweb.

### Проверка доступности Railway

1. Откройте в браузере домен Railway:
   - `https://backend.up.railway.app/api/cart/health`
   - Должен вернуться JSON ответ с информацией о здоровье сервиса

2. Откройте в браузере ваш домен (если настроен):
   - `https://example.com/api/cart/health`
   - Должен вернуться тот же ответ (через проксирование на Timeweb)

### Проверка failover

1. **Нормальная работа:**
   - Откройте `https://example.com/` в браузере — должен открыться сайт
   - Откройте `https://example.com/api/cart/health` — должен вернуться ответ от Railway

2. **Тест переключения на запасной сервер:**
   - Временно измените `__RAILWAY_ORIGIN__` в Nginx конфиге на несуществующий домен (например: `nonexistent.railway.app`)
   - Перезагрузите Nginx через веб-панель управления сервером
   - Откройте `https://example.com/api/cart/health` — должен вернуться ответ от локального backend на Timeweb
   - Верните правильное значение и перезагрузите Nginx

### Проверка SSL сертификата

Используйте онлайн-сервисы для проверки SSL:
- [SSL Labs SSL Test](https://www.ssllabs.com/ssltest/) — проверка SSL сертификата
- [SSL Checker](https://www.sslshopper.com/ssl-checker.html) — быстрая проверка сертификата

Введите ваш домен и проверьте, что сертификат валиден и выпущен для правильного домена.

---

## Troubleshooting

### Проблема: DNS записи не обновляются

- Подождите до 60 минут (время распространения DNS)
- Проверьте правильность записей через [whatsmydns.net](https://www.whatsmydns.net)
- Убедитесь, что TTL не слишком большой (рекомендуется 3600 секунд)
- Проверьте, что в DNS записи указан правильный IP адрес Timeweb

### Проблема: SSL сертификат не выпускается

- Убедитесь, что домен указывает на правильный IP адрес Timeweb
- Проверьте через веб-панель Timeweb, что порты 80 и 443 открыты
- Убедитесь, что домен доступен из интернета (не заблокирован firewall)
- Обратитесь в поддержку Timeweb для помощи с выпуском сертификата

### Проблема: Failover не работает

- Проверьте логи Nginx через веб-панель управления сервером Timeweb
- Убедитесь, что локальный backend запущен (проверьте через веб-панель или обратитесь в поддержку)
- Проверьте конфигурацию Nginx — убедитесь, что указан домен Railway (`backend.up.railway.app`), а не IP адрес
- Убедитесь, что в конфигурации Nginx правильно указаны пути к fallback серверам

### Проблема: Railway недоступен

1. Откройте [Railway Dashboard](https://railway.app)
2. Выберите ваш проект → сервис backend
3. Проверьте логи в разделе **Deployments** → выберите последний деплой → **View Logs**
4. Убедитесь, что сервис запущен (статус должен быть "Active")
5. Проверьте переменные окружения в **Variables**
6. Попробуйте перезапустить сервис через **Settings** → **Restart**

---

## Дополнительные ресурсы

- [`RAILWAY.md`](./RAILWAY.md) — общая документация по Railway
- [`RAILWAY_DOMAIN_EXPLAINED.md`](./RAILWAY_DOMAIN_EXPLAINED.md) — подробное объяснение разницы между IP и доменным именем
- [`TIMEWEB_FAILOVER.md`](./TIMEWEB_FAILOVER.md) — подробная инструкция по настройке failover
